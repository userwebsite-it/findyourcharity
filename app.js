
const INDEX_URL="data/index.json";const PAGE_SIZE=25;
function qs(s,el=document){return el.querySelector(s)}function qsa(s,el=document){return Array.from(el.querySelectorAll(s))}
async function loadIndex(){return fetch(INDEX_URL,{cache:'no-store'}).then(r=>r.json())}async function loadCategory(u){return fetch(u,{cache:'no-store'}).then(r=>r.json())}
function renderFeatured(el,items){el.innerHTML="";items.slice(0,12).forEach(c=>{const a=document.createElement('a');a.href=c.website;a.target='_blank';a.rel='noopener';a.className='card';a.innerHTML=`<img src="${c.image}" onerror="this.src='assets/logo.svg'"><div class='name'>${c.name}</div>`;el.appendChild(a);})}
async function mountIndex(){const idx=await loadIndex();const urls=Object.values(idx);const all=(await Promise.all(urls.slice(0,4).map(loadCategory))).flat();renderFeatured(qs('#feat1'),all.sort(()=>Math.random()-0.5).slice(0,12));const pills=qs('#pillwrap');Object.keys(idx).forEach(cat=>{const a=document.createElement('a');a.className='pill';a.textContent=cat;a.href=`category.html?category=${encodeURIComponent(cat)}`;pills.appendChild(a);});const form=qs('#globalSearch'),input=qs('#searchInput');form.addEventListener('submit',e=>{e.preventDefault();if(!input.value.trim())return;location.href=`category.html?category=${encodeURIComponent('Browse All')}&search=${encodeURIComponent(input.value.trim())}`;});}
async function mountCategory(){const idx=await loadIndex();const p=new URLSearchParams(location.search);const cat=p.get('category')||'Browse All';qs('#catTitle').textContent=cat;const pre=p.get('search')||'';let data=[];if(cat==='Browse All'){data=(await Promise.all(Object.values(idx).map(loadCategory))).flat();}else{data=await loadCategory(idx[cat])}qs('#q').value=pre;function apply(){const t=(qs('#q').value||'').toLowerCase();const size=(qs('#size')||{value:''}).value||'';const ver=qs('#ver')?qs('#ver').checked:false;const loc=(qs('#loc')||{value:''}).value.toLowerCase();const view=data.filter(c=>{const term=!t||(c.name+' '+(c.blurb||'')).toLowerCase().includes(t);const s=!size||(c.size||'').toLowerCase()===size.toLowerCase();const v=!ver||!!c.verified;const l=!loc||(c.location||'').toLowerCase().includes(loc);return term&&s&&v&&l;});render(1,view)}function render(page,view){const list=qs('#results');list.innerHTML='';const start=(page-1)*PAGE_SIZE;view.slice(start,start+PAGE_SIZE).forEach(c=>{const d=document.createElement('div');d.className='item';const r=(c.rating&&c.rating.toFixed)?c.rating.toFixed(1):c.rating;d.innerHTML=`<img class="thumb" src="${c.image}" onerror="this.src='assets/logo.svg'"><div style="flex:1"><div style="display:flex;justify-content:space-between"><h3 style="margin:0">${c.name}</h3><div class='rating'>${r}/10</div></div><div class='meta'>${c.category} · ${c.location||'—'} · ${c.size}</div><p style="margin:.4rem 0 0">${c.blurb||''}</p><div class='actions'><a class='btn' href="rating.html?id=${encodeURIComponent(c.id)}">Why this rating?</a><a class='btn primary' href="${c.website}" target="_blank" rel="noopener">Donate / Official Site</a></div></div>`;list.appendChild(d);});qs('#count').textContent=`${view.length}`;}document.addEventListener('DOMContentLoaded',()=>{const page=document.body.dataset.page;if(page==='index')mountIndex();if(page==='category')mountCategory();});
